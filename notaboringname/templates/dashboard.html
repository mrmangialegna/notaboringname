<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>My Notes & Calculator Dashboard</h1>
        <div style="float: right;">
            <span>Welcome, {{ session.username }}!</span>
            <a href="/logout" style="color: white; margin-left: 10px;">Logout</a>
        </div>
    </header>

    <div class="container">
        <!-- Notes Section -->
        <section>
            <h2>Notes</h2>
            <form id="noteForm">
                <textarea name="note" id="noteTextarea" placeholder="Add a new note..." required></textarea>
                <button type="submit" id="noteSubmitBtn">Add Note</button>
            </form>
            <ul id="notesList">
                {% if notes %}
                    {% for note in notes %}
                        <li class="note">{{ note.note if note.note is defined else note }}</li>
                    {% endfor %}
                {% else %}
                    <li class="note">No notes yet. Add one above!</li>
                {% endif %}
            </ul>
            <button id="downloadNotes">Download Notes</button>
        </section>

        <!-- Calculator Section -->
        <section>
            <h2>Calculator</h2>
            <form id="calcForm">
                <input type="text" name="expression" id="calcInput" placeholder="Enter expression" required>
                <button type="submit" id="calcSubmitBtn">Calculate</button>
            </form>
            <ul id="calcHistory">
                {% if calc_history %}
                    {% for entry in calc_history %}
                        <li class="calc-entry">{{ entry.expression if entry.expression is defined else entry }} = {{ entry.result if entry.result is defined else 'N/A' }}</li>
                    {% endfor %}
                {% else %}
                    <li class="calc-entry">No calculations yet. Try one above!</li>
                {% endif %}
            </ul>
        </section>

        <!-- Chart Section -->
        <section>
            <h2>Notes & Calculations Stats</h2>
            <canvas id="statsChart" width="400" height="200"></canvas>
        </section>
    </div>

    <script>
    // --- Helper functions ---
    function showLoading(button) {
        button.disabled = true;
        button.textContent = 'Loading...';
    }

    function hideLoading(button, originalText) {
        button.disabled = false;
        button.textContent = originalText;
    }

    function showError(message) {
        alert('Error: ' + message);
    }

    // --- Notes ---
    const noteForm = document.getElementById('noteForm');
    const noteSubmitBtn = document.getElementById('noteSubmitBtn');
    const noteTextarea = document.getElementById('noteTextarea');

    noteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const originalText = noteSubmitBtn.textContent;
        showLoading(noteSubmitBtn);
        
        try {
            const formData = new FormData(noteForm);
            const response = await fetch('/add_note', {
                method: 'POST',
                body: new URLSearchParams({note: formData.get('note')})
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            if (data.status === 'ok') {
                noteTextarea.value = ''; // Clear textarea
                location.reload();
            } else {
                showError('Failed to add note');
            }
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading(noteSubmitBtn, originalText);
        }
    });

    document.getElementById('downloadNotes').addEventListener('click', () => {
        window.location.href = '/download_notes';
    });

    // --- Calculator ---
    const calcForm = document.getElementById('calcForm');
    const calcSubmitBtn = document.getElementById('calcSubmitBtn');
    const calcInput = document.getElementById('calcInput');

    calcForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const originalText = calcSubmitBtn.textContent;
        showLoading(calcSubmitBtn);
        
        try {
            const formData = new FormData(calcForm);
            const response = await fetch('/calculate', {
                method: 'POST',
                body: new URLSearchParams({expression: formData.get('expression')})
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            if (data.result !== undefined) {
                calcInput.value = ''; // Clear input
                location.reload();
            } else {
                showError(data.error || 'Calculation failed');
            }
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading(calcSubmitBtn, originalText);
        }
    });

    // --- Chart ---
    </script>
    
    <script id="data" type="application/json">
    {
        "notesCount": {{ notes|length if notes is defined else 0 }},
        "calcCount": {{ calc_history|length if calc_history is defined else 0 }}
    }
    </script>
    
    <script>
    const data = JSON.parse(document.getElementById('data').textContent);
    const notesCount = data.notesCount;
    const calcCount = data.calcCount;

    if (notesCount > 0 || calcCount > 0) {
        const ctx = document.getElementById('statsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Notes', 'Calculations'],
                datasets: [{
                    label: 'Items count',
                    data: [notesCount, calcCount],
                    backgroundColor: ['#007BFF', '#28a745']
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, precision: 0 } }
            }
        });
    } else {
        document.getElementById('statsChart').style.display = 'none';
        document.querySelector('#statsChart').parentNode.innerHTML = '<p>No data to display yet. Add some notes or calculations!</p>';
    }
    </script>
</body>
</html>